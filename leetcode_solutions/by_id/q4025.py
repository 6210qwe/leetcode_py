# -*- coding:utf-8 -*-
# ============================================================================
# 题目信息
# ============================================================================
"""
题号: 4025
标题: Find Loyal Customers
难度: medium
链接: https://leetcode.cn/problems/find-loyal-customers/
题目类型: 其他
"""

# ============================================================================
# 问题描述
# ============================================================================
"""
3657. 寻找忠实客户 - 表：customer_transactions +------------------+---------+ | Column Name | Type | +------------------+---------+ | transaction_id | int | | customer_id | int | | transaction_date | date | | amount | decimal | | transaction_type | varchar | +------------------+---------+ transaction_id 是这张表的唯一主键。 transaction_type 可以是 “purchase” 或 “refund”。 编写一个解决方案来查找 忠实客户。如果满足下述所有条件，可以认为该客户是 忠实 客户： * 进行了 至少 3 次购买交易。 * 活跃了 至少 30 天。 * 他们的 退款率 少于 20%。 退款率是退款交易占交易总数（购买加退款）的比例，计算公式为退款交易数量除以总交易数量。 返回结果表以 customer_id 升序 排序。 结果格式如下所示。 示例： 输入： customer_transactions 表： +----------------+-------------+------------------+--------+------------------+ | transaction_id | customer_id | transaction_date | amount | transaction_type | +----------------+-------------+------------------+--------+------------------+ | 1 | 101 | 2024-01-05 | 150.00 | purchase | | 2 | 101 | 2024-01-15 | 200.00 | purchase | | 3 | 101 | 2024-02-10 | 180.00 | purchase | | 4 | 101 | 2024-02-20 | 250.00 | purchase | | 5 | 102 | 2024-01-10 | 100.00 | purchase | | 6 | 102 | 2024-01-12 | 120.00 | purchase | | 7 | 102 | 2024-01-15 | 80.00 | refund | | 8 | 102 | 2024-01-18 | 90.00 | refund | | 9 | 102 | 2024-02-15 | 130.00 | purchase | | 10 | 103 | 2024-01-01 | 500.00 | purchase | | 11 | 103 | 2024-01-02 | 450.00 | purchase | | 12 | 103 | 2024-01-03 | 400.00 | purchase | | 13 | 104 | 2024-01-01 | 200.00 | purchase | | 14 | 104 | 2024-02-01 | 250.00 | purchase | | 15 | 104 | 2024-02-15 | 300.00 | purchase | | 16 | 104 | 2024-03-01 | 350.00 | purchase | | 17 | 104 | 2024-03-10 | 280.00 | purchase | | 18 | 104 | 2024-03-15 | 100.00 | refund | +----------------+-------------+------------------+--------+------------------+ 输出： +-------------+ | customer_id | +-------------+ | 101 | | 104 | +-------------+ 解释： * 客户 101: * 购买交易：4 (IDs: 1, 2, 3, 4) * 退款交易：0 * 退款率：0/4 = 0%（少于 20%） * 活跃时期：1 月 5 日到 2 月 20 日 = 46 天（至少 30 天） * 符合忠诚客户条件 * 客户 102: * 购买交易：3 (IDs: 5, 6, 9) * 退款交易：2 (IDs: 7, 8) * 退款率：2/5 = 40% (超过 20%) * 不符合忠诚客户条件 * 客户 103: * 购买交易：3 (IDs: 10, 11, 12) * 退款交易：0 * 退款率：0/3 = 0%（少于 20%） * 活跃时期：1 月 1 日到 1 月 3 日 = 2 天（少于 30 天） * 不符合忠诚客户条件 * 客户 104: * 购买交易：5 (IDs: 13, 14, 15, 16, 17) * 退款交易：1 (ID: 18) * 退款率：1/6 = 16.67%（少于 20%） * 活跃时期：1 月 1 日到 3 月 15 日 = 73 天（至少 30 天） * 符合忠诚客户条件 结果表以 customer_id 升序排序。
"""

# ============================================================================
# 实现思路
# ============================================================================
"""
核心思想:
1. 使用 Pandas 库进行数据处理和分析。
2. 计算每个客户的购买次数、退款次数和活跃天数。
3. 筛选出符合条件的忠实客户。

算法步骤:
1. 读取输入数据并转换为 Pandas DataFrame。
2. 计算每个客户的购买次数和退款次数。
3. 计算每个客户的活跃天数。
4. 计算每个客户的退款率。
5. 筛选出符合条件的忠实客户。
6. 返回结果表并按 customer_id 升序排序。

关键点:
- 使用 Pandas 的 groupby 和 agg 方法进行分组聚合。
- 使用 Pandas 的日期处理功能计算活跃天数。
- 使用 Pandas 的筛选功能过滤出符合条件的忠实客户。
"""

# ============================================================================
# 复杂度分析
# ============================================================================
"""
时间复杂度: O(n)，其中 n 是 customer_transactions 表的长度。主要操作包括分组聚合和筛选。
空间复杂度: O(n)，使用了额外的 Pandas DataFrame 存储中间结果。
"""

# ============================================================================
# 代码实现
# ============================================================================

import pandas as pd

def find_loyal_customers(customer_transactions: pd.DataFrame) -> pd.DataFrame:
    # 计算每个客户的购买次数和退款次数
    transaction_counts = customer_transactions.groupby('customer_id')['transaction_type'].value_counts().unstack(fill_value=0)
    
    # 计算每个客户的活跃天数
    active_days = customer_transactions.groupby('customer_id')['transaction_date'].agg(['min', 'max'])
    active_days['active_days'] = (active_days['max'] - active_days['min']).dt.days
    
    # 合并结果
    result = transaction_counts.join(active_days)
    
    # 计算退款率
    result['refund_rate'] = result['refund'] / (result['purchase'] + result['refund'])
    
    # 筛选出符合条件的忠实客户
    loyal_customers = result[
        (result['purchase'] >= 3) &
        (result['active_days'] >= 30) &
        (result['refund_rate'] < 0.2)
    ].index
    
    # 返回结果表并按 customer_id 升序排序
    return pd.DataFrame(loyal_customers, columns=['customer_id']).sort_values(by='customer_id')

Solution = create_solution(find_loyal_customers)