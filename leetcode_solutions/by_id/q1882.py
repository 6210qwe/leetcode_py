# -*- coding:utf-8 -*-
# ============================================================================
# 题目信息
# ============================================================================
"""
题号: 1882
标题: The Number of Employees Which Report to Each Employee
难度: easy
链接: https://leetcode.cn/problems/the-number-of-employees-which-report-to-each-employee/
题目类型: 数据库
"""

# ============================================================================
# 问题描述
# ============================================================================
"""
1731. 每位经理的下属员工数量 - 表：Employees +-------------+----------+ | Column Name | Type | +-------------+----------+ | employee_id | int | | name | varchar | | reports_to | int | | age | int | +-------------+----------+ employee_id 是这个表中具有不同值的列。 该表包含员工以及需要听取他们汇报的上级经理的 ID 的信息。 有些员工不需要向任何人汇报（reports_to 为空）。 对于此问题，我们将至少有一个其他员工需要向他汇报的员工，视为一个经理。 编写一个解决方案来返回需要听取汇报的所有经理的 ID、名称、直接向该经理汇报的员工人数，以及这些员工的平均年龄，其中该平均年龄需要四舍五入到最接近的整数。 返回的结果集需要按照 employee_id 进行排序。 结果的格式如下： 示例 1: 输入： Employees 表： +-------------+---------+------------+-----+ | employee_id | name | reports_to | age | +-------------+---------+------------+-----+ | 9 | Hercy | null | 43 | | 6 | Alice | 9 | 41 | | 4 | Bob | 9 | 36 | | 2 | Winston | null | 37 | +-------------+---------+------------+-----+ 输出： +-------------+-------+---------------+-------------+ | employee_id | name | reports_count | average_age | +-------------+-------+---------------+-------------+ | 9 | Hercy | 2 | 39 | +-------------+-------+---------------+-------------+ 解释： Hercy 有两个需要向他汇报的员工, 他们是 Alice and Bob. 他们的平均年龄是 (41+36)/2 = 38.5, 四舍五入的结果是 39. 示例 2: 输入： Employees 表： +-------------+---------+------------+-----+ | employee_id | name | reports_to | age | |-------------|---------|------------|-----| | 1 | Michael | null | 45 | | 2 | Alice | 1 | 38 | | 3 | Bob | 1 | 42 | | 4 | Charlie | 2 | 34 | | 5 | David | 2 | 40 | | 6 | Eve | 3 | 37 | | 7 | Frank | null | 50 | | 8 | Grace | null | 48 | +-------------+---------+------------+-----+ 输出： +-------------+---------+---------------+-------------+ | employee_id | name | reports_count | average_age | | ----------- | ------- | ------------- | ----------- | | 1 | Michael | 2 | 40 | | 2 | Alice | 2 | 37 | | 3 | Bob | 1 | 37 | +-------------+---------+---------------+-------------+
"""

# ============================================================================
# 实现思路
# ============================================================================
"""
核心思想:
1. 使用 Pandas 库处理数据。
2. 先筛选出有下属的经理。
3. 计算每个经理的下属数量和平均年龄。

算法步骤:
1. 读取 Employees 表。
2. 筛选出有下属的经理。
3. 计算每个经理的下属数量和平均年龄。
4. 将结果按 employee_id 排序并返回。

关键点:
- 使用 Pandas 库进行高效的数据处理。
- 使用 groupby 和 agg 函数计算每个经理的下属数量和平均年龄。
"""

# ============================================================================
# 复杂度分析
# ============================================================================
"""
时间复杂度: O(n)，其中 n 是 Employees 表的长度。因为我们需要遍历整个表来计算每个经理的下属数量和平均年龄。
空间复杂度: O(n)，因为我们需要存储中间结果。
"""

# ============================================================================
# 代码实现
# ============================================================================

import pandas as pd


def solution(employees: pd.DataFrame) -> pd.DataFrame:
    """
    函数式接口 - 实现最优解法
    """
    # 筛选出有下属的经理
    managers = employees[employees['reports_to'].notna()]['reports_to'].unique()
    
    # 计算每个经理的下属数量和平均年龄
    result = (
        employees[employees['employee_id'].isin(managers)]
        .groupby(['employee_id', 'name'])
        .agg(reports_count=('age', 'count'), average_age=('age', 'mean'))
        .reset_index()
    )
    
    # 四舍五入平均年龄
    result['average_age'] = result['average_age'].round().astype(int)
    
    # 按 employee_id 排序
    result = result.sort_values(by='employee_id')
    
    return result


Solution = create_solution(solution)