# -*- coding:utf-8 -*-
# ============================================================================
# 题目信息
# ============================================================================
"""
题号: 699
标题: Falling Squares
难度: hard
链接: https://leetcode.cn/problems/falling-squares/
题目类型: 线段树、数组、有序集合
"""

# ============================================================================
# 问题描述
# ============================================================================
"""
699. 掉落的方块 - 在二维平面上的 x 轴上，放置着一些方块。 给你一个二维整数数组 positions ，其中 positions[i] = [lefti, sideLengthi] 表示：第 i 个方块边长为 sideLengthi ，其左侧边与 x 轴上坐标点 lefti 对齐。 每个方块都从一个比目前所有的落地方块更高的高度掉落而下。方块沿 y 轴负方向下落，直到着陆到 另一个正方形的顶边 或者是 x 轴上 。一个方块仅仅是擦过另一个方块的左侧边或右侧边不算着陆。一旦着陆，它就会固定在原地，无法移动。 在每个方块掉落后，你必须记录目前所有已经落稳的 方块堆叠的最高高度 。 返回一个整数数组 ans ，其中 ans[i] 表示在第 i 块方块掉落后堆叠的最高高度。 示例 1： [https://assets.leetcode.com/uploads/2021/04/28/fallingsq1-plane.jpg] 输入：positions = [[1,2],[2,3],[6,1]] 输出：[2,5,5] 解释： 第 1 个方块掉落后，最高的堆叠由方块 1 组成，堆叠的最高高度为 2 。 第 2 个方块掉落后，最高的堆叠由方块 1 和 2 组成，堆叠的最高高度为 5 。 第 3 个方块掉落后，最高的堆叠仍然由方块 1 和 2 组成，堆叠的最高高度为 5 。 因此，返回 [2, 5, 5] 作为答案。 示例 2： 输入：positions = [[100,100],[200,100]] 输出：[100,100] 解释： 第 1 个方块掉落后，最高的堆叠由方块 1 组成，堆叠的最高高度为 100 。 第 2 个方块掉落后，最高的堆叠可以由方块 1 组成也可以由方块 2 组成，堆叠的最高高度为 100 。 因此，返回 [100, 100] 作为答案。 注意，方块 2 擦过方块 1 的右侧边，但不会算作在方块 1 上着陆。 提示： * 1 <= positions.length <= 1000 * 1 <= lefti <= 108 * 1 <= sideLengthi <= 106
"""

# ============================================================================
# 实现思路
# ============================================================================
"""
核心思想: 使用有序集合来维护当前所有方块的高度，并通过二分查找来快速找到重叠部分的最大高度。

算法步骤:
1. 初始化一个有序集合 `events` 来存储所有方块的左右边界及其对应的高度。
2. 遍历每个方块，计算其左边界和右边界。
3. 使用二分查找找到当前方块范围内的最大高度。
4. 更新当前方块的高度，并将其左右边界及对应高度加入有序集合。
5. 记录当前所有方块的最大高度。

关键点:
- 使用有序集合来高效地管理和查询区间。
- 通过二分查找快速找到重叠部分的最大高度。
"""

# ============================================================================
# 复杂度分析
# ============================================================================
"""
时间复杂度: O(n log n)，其中 n 是方块的数量。每次插入和查询操作的时间复杂度为 O(log n)。
空间复杂度: O(n)，需要存储每个方块的左右边界及其对应的高度。
"""

# ============================================================================
# 代码实现
# ============================================================================

from typing import List
from sortedcontainers import SortedDict

def fallingSquares(positions: List[List[int]]) -> List[int]:
    events = SortedDict()
    max_heights = []
    current_max_height = 0
    
    for left, size in positions:
        right = left + size
        start = events.bisect_left(left)
        end = events.bisect_right(right)
        
        max_height = 0
        if start < len(events):
            max_height = max(max_height, events.peekitem(start)[1])
        if end > 0:
            max_height = max(max_height, events.peekitem(end - 1)[1])
        
        new_height = max_height + size
        current_max_height = max(current_max_height, new_height)
        
        events[left] = new_height
        events[right] = max_height
        
        max_heights.append(current_max_height)
    
    return max_heights

Solution = create_solution(fallingSquares)