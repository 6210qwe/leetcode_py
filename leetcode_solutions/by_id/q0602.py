# -*- coding:utf-8 -*-
# ============================================================================
# 题目信息
# ============================================================================
"""
题号: 602
标题: Friend Requests II: Who Has the Most Friends
难度: medium
链接: https://leetcode.cn/problems/friend-requests-ii-who-has-the-most-friends/
题目类型: 数据库
"""

# ============================================================================
# 问题描述
# ============================================================================
"""
602. 好友申请 II ：谁有最多的好友 - RequestAccepted 表： +----------------+---------+ | Column Name | Type | +----------------+---------+ | requester_id | int | | accepter_id | int | | accept_date | date | +----------------+---------+ (requester_id, accepter_id) 是这张表的主键(具有唯一值的列的组合)。 这张表包含发送好友请求的人的 ID ，接收好友请求的人的 ID ，以及好友请求通过的日期。 编写解决方案，找出拥有最多的好友的人和他拥有的好友数目。 生成的测试用例保证拥有最多好友数目的只有 1 个人。 查询结果格式如下例所示。 示例 1： 输入： RequestAccepted 表： +--------------+-------------+-------------+ | requester_id | accepter_id | accept_date | +--------------+-------------+-------------+ | 1 | 2 | 2016/06/03 | | 1 | 3 | 2016/06/08 | | 2 | 3 | 2016/06/08 | | 3 | 4 | 2016/06/09 | +--------------+-------------+-------------+ 输出： +----+-----+ | id | num | +----+-----+ | 3 | 3 | +----+-----+ 解释： 编号为 3 的人是编号为 1 ，2 和 4 的人的好友，所以他总共有 3 个好友，比其他人都多。 进阶：在真实世界里，可能会有多个人拥有好友数相同且最多，你能找到所有这些人吗？
"""

# ============================================================================
# 实现思路
# ============================================================================
"""
核心思想: 使用 SQL 查询来统计每个用户的好友数量，并找出最多的好友数量。

算法步骤:
1. 创建一个临时表，将 `requester_id` 和 `accepter_id` 合并到一列。
2. 使用 `GROUP BY` 和 `COUNT` 统计每个用户的好友数量。
3. 找出最大好友数量的用户。

关键点:
- 使用 `UNION ALL` 将 `requester_id` 和 `accepter_id` 合并到一列。
- 使用 `GROUP BY` 和 `COUNT` 统计每个用户的好友数量。
- 使用子查询找出最大好友数量的用户。
"""

# ============================================================================
# 复杂度分析
# ============================================================================
"""
时间复杂度: O(n)
空间复杂度: O(n)
"""

# ============================================================================
# 代码实现
# ============================================================================

def solution_function_name(request_accepted):
    """
    函数式接口 - 实现
    """
    # 合并 requester_id 和 accepter_id 到一列
    combined = request_accepted.withColumn("user_id", F.col("requester_id")).unionAll(
        request_accepted.withColumn("user_id", F.col("accepter_id"))
    )
    
    # 统计每个用户的好友数量
    friend_counts = combined.groupBy("user_id").count()
    
    # 找出最大好友数量的用户
    max_friends = friend_counts.agg(F.max("count").alias("max_count"))
    result = friend_counts.join(max_friends, friend_counts["count"] == max_friends["max_count"]).select("user_id", "count")
    
    return result

Solution = create_solution(solution_function_name)