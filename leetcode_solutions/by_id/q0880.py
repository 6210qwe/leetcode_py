# -*- coding:utf-8 -*-
# ============================================================================
# 题目信息
# ============================================================================
"""
题号: 880
标题: Rectangle Area II
难度: hard
链接: https://leetcode.cn/problems/rectangle-area-ii/
题目类型: 线段树、数组、有序集合、扫描线
"""

# ============================================================================
# 问题描述
# ============================================================================
"""
850. 矩形面积 II - 给你一个轴对齐的二维数组 rectangles 。 对于 rectangle[i] = [x1, y1, x2, y2]，其中 (xi1, yi1) 是该矩形 左下角 的坐标， (xi2, yi2) 是该矩形 右上角 的坐标。 计算平面中所有 rectangles 所覆盖的 总面积 。任何被两个或多个矩形覆盖的区域应只计算 一次 。 返回 总面积 。因为答案可能太大，返回 109 + 7 的 模 。 示例 1： [https://s3-lc-upload.s3.amazonaws.com/uploads/2018/06/06/rectangle_area_ii_pic.png] 输入：rectangles = [[0,0,2,2],[1,0,2,3],[1,0,3,1]] 输出：6 解释：如图所示，三个矩形覆盖了总面积为 6 的区域。 从(1,1)到(2,2)，绿色矩形和红色矩形重叠。 从(1,0)到(2,3)，三个矩形都重叠。 示例 2： 输入：rectangles = [[0,0,1000000000,1000000000]] 输出：49 解释：答案是 1018 对 (109 + 7) 取模的结果， 即 49 。 提示： * 1 <= rectangles.length <= 200 * rectanges[i].length = 4 * 0 <= xi1, yi1, xi2, yi2 <= 109 * xi1 <= xi2 * yi1 <= yi2 * 所有矩阵面积不为 0。
"""

# ============================================================================
# 实现思路
# ============================================================================
"""
核心思想: 使用扫描线算法结合有序集合来计算矩形的总面积。

算法步骤:
1. 将所有矩形的左边界和右边界分别作为事件加入到一个列表中，并标记它们是进入还是离开。
2. 按照 x 坐标对事件进行排序，如果 x 坐标相同，则进入事件优先于离开事件。
3. 使用一个有序集合来维护当前活动的 y 区间，并在处理每个事件时更新区间。
4. 在处理每个事件时，计算当前活动的 y 区间的总长度，并乘以当前事件与前一个事件之间的 x 距离，累加到总面积中。
5. 最后返回总面积对 10^9 + 7 取模的结果。

关键点:
- 使用有序集合来高效地维护和更新当前活动的 y 区间。
- 通过扫描线算法，将二维问题转化为一维问题，从而简化计算。
"""

# ============================================================================
# 复杂度分析
# ============================================================================
"""
时间复杂度: O(n log n)，其中 n 是矩形的数量。排序操作的时间复杂度为 O(n log n)，每次插入和删除有序集合的操作时间复杂度为 O(log n)。
空间复杂度: O(n)，用于存储事件和有序集合。
"""

# ============================================================================
# 代码实现
# ============================================================================

from typing import List
import sortedcontainers

MOD = 10**9 + 7

def solution_function_name(rectangles: List[List[int]]) -> int:
    events = []
    for x1, y1, x2, y2 in rectangles:
        events.append((x1, 1, y1, y2))  # 进入事件
        events.append((x2, -1, y1, y2))  # 离开事件
    events.sort()

    active_y_intervals = sortedcontainers.SortedSet()
    prev_x = 0
    total_area = 0

    for x, typ, y1, y2 in events:
        if prev_x < x:
            total_length = 0
            prev_y = -1
            for y in active_y_intervals:
                if y > prev_y:
                    total_length += y - prev_y
                prev_y = y
            total_area += total_length * (x - prev_x)
            total_area %= MOD
            prev_x = x

        if typ == 1:
            active_y_intervals.add(y1)
            active_y_intervals.add(y2)
        else:
            active_y_intervals.discard(y1)
            active_y_intervals.discard(y2)

    return total_area

Solution = create_solution(solution_function_name)