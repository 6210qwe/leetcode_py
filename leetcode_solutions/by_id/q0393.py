# -*- coding:utf-8 -*-
# ============================================================================
# 题目信息
# ============================================================================
"""
题号: 393
标题: UTF-8 Validation
难度: medium
链接: https://leetcode.cn/problems/utf-8-validation/
题目类型: 位运算、数组
"""

# ============================================================================
# 问题描述
# ============================================================================
"""
393. UTF-8 编码验证 - 给定一个表示数据的整数数组 data ，返回它是否为有效的 UTF-8 编码。 UTF-8 中的一个字符可能的长度为 1 到 4 字节，遵循以下的规则： 1. 对于 1 字节 的字符，字节的第一位设为 0 ，后面 7 位为这个符号的 unicode 码。 2. 对于 n 字节 的字符 (n > 1)，第一个字节的前 n 位都设为1，第 n+1 位设为 0 ，后面字节的前两位一律设为 10 。剩下的没有提及的二进制位，全部为这个符号的 unicode 码。 这是 UTF-8 编码的工作方式： Number of Bytes | UTF-8 octet sequence | (binary) --------------------+--------------------------------------------- 1 | 0xxxxxxx 2 | 110xxxxx 10xxxxxx 3 | 1110xxxx 10xxxxxx 10xxxxxx 4 | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx x 表示二进制形式的一位，可以是 0 或 1。 注意：输入是整数数组。只有每个整数的 最低 8 个有效位 用来存储数据。这意味着每个整数只表示 1 字节的数据。 示例 1： 输入：data = [197,130,1] 输出：true 解释：数据表示字节序列:11000101 10000010 00000001。 这是有效的 utf-8 编码，为一个 2 字节字符，跟着一个 1 字节字符。 示例 2： 输入：data = [235,140,4] 输出：false 解释：数据表示 8 位的序列: 11101011 10001100 00000100. 前 3 位都是 1 ，第 4 位为 0 表示它是一个 3 字节字符。 下一个字节是开头为 10 的延续字节，这是正确的。 但第二个延续字节不以 10 开头，所以是不符合规则的。 提示: * 1 <= data.length <= 2 * 104 * 0 <= data[i] <= 255
"""

# ============================================================================
# 实现思路
# ============================================================================
"""
核心思想: 按字节顺序解析 UTF-8 字符，统计首字节前导 1 的个数来确定连续字节数，并检查后续字节是否以 10 开头。

算法步骤:
1. 从左到右遍历数组 `data`：
   - 对当前字节 b，统计其二进制从高位开始连续 1 的个数 cnt。
   - 若 cnt==0，说明是 1 字节字符，直接跳过当前字节。
   - 若 cnt==1 或 cnt>4，则非法（不存在这种 UTF-8 开头形式）。
   - 若剩余字节数少于 cnt，则非法。
2. 对后续 cnt-1 个字节，检查其最高两位是否为二进制 10（即 `(byte & 0xC0) == 0x80`），如有一个不满足则非法。
3. 全部解析完成且无违规情况则返回 True。

关键点:
- 只使用每个整数的低 8 位，避免受高位干扰。
- 严格按照 UTF-8 定义判断前导 1 的个数与后续字节格式。
"""

# ============================================================================
# 复杂度分析
# ============================================================================
"""
时间复杂度: O(n)，n 为字节数，每个字节至多访问常数次。
空间复杂度: O(1)，只使用常数额外变量。
"""

# ============================================================================
# 代码实现
# ============================================================================

from typing import List, Optional
from leetcode_solutions.utils.linked_list import ListNode
from leetcode_solutions.utils.tree import TreeNode
from leetcode_solutions.utils.solution import create_solution


def utf_8_validation(data: List[int]) -> bool:
    """
    判断整数数组是否为有效 UTF-8 编码序列。

    逐个解析首字节确定后续字节数，并检查后续字节是否都以 10 开头。
    """
    i = 0
    n = len(data)

    while i < n:
        b = data[i] & 0xFF
        # 计算首字节前导 1 的个数
        mask = 0b10000000
        cnt = 0
        while mask & b:
            cnt += 1
            mask >>= 1
        if cnt == 0:
            i += 1
            continue
        if cnt == 1 or cnt > 4:
            return False
        if i + cnt > n:
            return False
        # 检查后续字节是否都以 10 开头
        for j in range(i + 1, i + cnt):
            if (data[j] & 0xC0) != 0x80:
                return False
        i += cnt

    return True


# 自动生成Solution类（无需手动编写）
Solution = create_solution(utf_8_validation)
